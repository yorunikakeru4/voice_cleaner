# Voice Cleaner

Утилита для автоматической очистки речи в видео от фоновых шумов, музыки и помех с сохранением разборчивости голоса.

## Описание

Voice Cleaner обрабатывает видеофайлы с речью и музыкой, применяя адаптивную аудиофильтрацию для максимальной разборчивости голоса при минимальных искажениях. Система автоматически анализирует входящее аудио и подбирает оптимальные параметры обработки.

## Технологический стек

- **Python 3.12** - основной язык разработки
- **FFmpeg** - обработка аудио и видео
- **FFprobe** - анализ медиафайлов
- **Docker / Podman** - контейнеризация
- **Nix** - альтернативное окружение разработки

## Ключевые особенности

### Автоматический анализ
- Определение частоты дискретизации и количества каналов
- Измерение RMS уровня и пикового уровня громкости
- Оценка динамического диапазона
- Детекция клиппинга в исходном файле
- Классификация уровня шума (low/medium/high)

### Адаптивная обработка
- Генерация оптимальной цепочки фильтров на основе анализа
- Масштабирование агрессивности обработки в зависимости от уровня шума
- Сохранение естественности голоса при подавлении помех
- Автоматическая нормализация громкости

### Цепочка обработки
1. **Частотная фильтрация** - удаление низкочастотного гула и высокочастотного шума
2. **FFT шумоподавление** - спектральная очистка (afftdn)
3. **Gate фильтр** - интеллектуальное подавление пауз и тишины
4. **Эквализация** - усиление речевого диапазона (2-3 kHz)
5. **Де-эссинг** - контроль шипящих звуков
6. **Компрессия** - выравнивание динамики речи
7. **Лимитирование** - защита от клиппинга
8. **Loudness нормализация** - финальное выравнивание громкости

### Гарантии качества
- Сохранение синхронизации аудио и видео
- Валидация длительности выходного файла
- Детекция клиппинга в результате
- Копирование видеопотока без реенкодинга
- Fallback конфигурация при ошибках анализа

### Ограничения
- Только стандартная библиотека Python
- Без использования нейросетей и внешних моделей
- Без separation библиотек (Demucs, UVR, Whisper)
- Полностью автономная работа без интернета

## Установка и запуск

### Docker Compose (рекомендуется)

```bash
docker-compose up --build
```

### Docker

```bash
# Сборка образа
docker build -t voice_cleaner .

# Запуск контейнера
docker run --rm voice_cleaner

# Вход в контейнер для отладки
docker exec -it voice_cleaner bash
```

### Podman

Контейнер совместим с Podman, используются абсолютные ссылки на образы:

```bash
podman-compose up --build
```

### Nix

```bash
nix develop
```

## Использование

### Автоматический режим (рекомендуется)

Обрабатывает все видео из `data/fixtures/` и сохраняет результаты в `data/output/`:

```bash
python -m voice_cleaner auto
```

Использует автоанализ и адаптивную конфигурацию из `config/filters.json`:

```json
{
  "auto_analyze": true,
  "audio_codec": "aac",
  "audio_bitrate": "256k"
}
```

### Ручной режим

Указание конкретных путей и конфигурации:

```bash
python -m voice_cleaner INPUT_PATH OUTPUT_PATH CONFIG_PATH
```

Параметры (порядковые параметры, не требуют флагов):
-  `input` - путь к входному видеофайлу или папке
- `output` - путь к выходному файлу или папке
- `config` - путь к JSON конфигурации (по умолчанию: `config/filters.json`)

### Примеры

```bash
# Обработка одного файла
python -m voice_cleaner -i video.mp4 -o clean_video.mp4

# Обработка папки
python -m voice_cleaner -i ./videos/ -o ./output/

# Использование кастомной конфигурации
python -m voice_cleaner -i video.mp4 -o output.mp4 -c my_config.json
```

## Структура проекта

```
voice_cleaner/
├── config/
│   └── filters.json          # Конфигурация фильтров
├── data/
│   ├── fixtures/             # Входные видеофайлы
│   └── output/               # Обработанные результаты
├── src/
│   ├── analyze.py            # Модуль анализа аудио
│   ├── cli.py                # Обработка аргументов командной строки
│   ├── config.py             # Загрузка конфигурации
│   ├── filters.py            # Построитель цепочки фильтров
│   └── pipeline.py           # Основная логика обработки
├── docker-compose.yml
├── Dockerfile
├── flake.nix                 # Nix конфигурация
└── voice_cleaner.py          # Точка входа
```

## Формат конфигурации

### Автоматический режим

```json
{
  "auto_analyze": true,
  "audio_codec": "aac",
  "audio_bitrate": "256k"
}
```

### Ручной режим

```json
{
  "auto_analyze": false,
  "audio_codec": "aac",
  "audio_bitrate": "256k",
  "audio_filters": [
    {
      "name": "highpass",
      "args": {"f": 100, "p": 1}
    },
    {
      "name": "lowpass",
      "args": {"f": 12000, "p": 1}
    },
    {
      "name": "afftdn",
      "args": {"nr": 10, "nf": -25}
    }
  ]
}
```


## Поддерживаемые форматы

**Входные:**
- MP4
- MKV
- MOV

**Выходные:**
- MP4 (AAC аудио, H.264 видео без реенкодинга)

## Требования к окружению

- Docker 20.10+ или Podman 3.0+
- 2 GB свободной оперативной памяти
- Поддержка x86_64 архитектуры

## Разработка

### Структура модулей

- **analyze.py** - анализ аудио характеристик, генерация конфигурации
- **pipeline.py** - основной процессинг, интеграция с FFmpeg
- **filters.py** - построение цепочки фильтров FFmpeg
- **cli.py** - парсинг аргументов, валидация путей
- **config.py** - загрузка и валидация JSON конфигурации


## Лицензия

Тестовое задание. Все права защищены.

## Автор

Разработано с использованием Neovim, Open source хаха
